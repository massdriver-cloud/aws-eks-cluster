schema: draft-07
name: aws-eks-cluster
version: 2.0.0
description: Elastic Kubernetes Service is an open source container orchestration platform that automates many of the manual processes involved in deploying, managing, and scaling containerized applications.
source_url: https://github.com/massdriver-cloud/aws-eks-cluster

steps:
- path: src
  provisioner: opentofu
- path: core-services
  provisioner: opentofu

params:
  examples:
  - __name: Wizard
    k8s_version: '1.34'
    fargate:
      enabled: false
    node_groups:
    - name: shared
      instance_type: t3.medium
      min_size: 1
      max_size: 10
      advanced_configuration_enabled: false
  - __name: Development
    k8s_version: '1.34'
    node_groups:
    - name: shared
      instance_type: t3.medium
      min_size: 1
      max_size: 10
  - __name: Production
    k8s_version: '1.34'
    node_groups:
    - name: shared
      instance_type: c5.2xlarge
      min_size: 1
      max_size: 10
  required:
  - k8s_version
  - node_groups
  - monitoring
  properties:
    k8s_version:
      type: string
      title: Kubernetes Version
      description: 'The version of Kubernetes to run. **WARNING: Upgrading Kubernetes version must be done one minor version at a time**. For example, upgrading from 1.31 to 1.33 requires upgrading to 1.32 first.'
      default: '1.34'
      enum:
      - '1.27'
      - '1.28'
      - '1.29'
      - '1.30'
      - '1.31'
      - '1.32'
      - '1.33'
      - '1.34'
    fargate:
      type: object
      title: Fargate
      description: AWS Fargate provides on-demand, right-sized compute capacity for running containers on EKS without managing node pools or clusters of EC2 instances.
      dependencies:
        enabled:
          oneOf:
          - properties:
              enabled:
                const: false
          - required:
            - namespaces
            properties:
              enabled:
                const: true
              namespaces:
                type: array
                items:
                  "$ref": https://raw.githubusercontent.com/massdriver-cloud/json-schemas/main/k8s/namespace.json
                  not:
                    enum:
                    - kube-system
                    - md-core-services
                    - md-observability
                minItems: 1
                uniqueItems: true
                title: Fargate Namespaces
                description: Namespaces that will run in Fargate
                default:
                - default
      properties:
        enabled:
          type: boolean
          default: false
          title: Enable
          description: Enables EKS Fargate
    node_groups:
      type: array
      title: Node Groups
      description: Node groups to provision
      minItems: 1
      items:
        type: object
        title: Node Group
        description: Definition of a node group
        required:
        - name
        - instance_type
        - min_size
        - max_size
        - advanced_configuration_enabled
        properties:
          name:
            type: string
            title: Name
            description: The name of the node group
            pattern: "[a-z]{1,}[a-z0-9]{0,19}"
            message:
              pattern: Name must be between 1 and 20 lowercase letters or numbers, and must start with a letter.
            default: ''
          min_size:
            type: integer
            title: Minimum Size
            description: Minimum number of instances in the node group
            default: 1
            minimum: 0
          max_size:
            type: integer
            title: Maximum Size
            description: Maximum number of instances in the node group
            default: 10
            minimum: 0
          instance_type:
            title: Instance type
            description: Instance type to use in the node group
            type: string
            oneOf:
            - title: C7i High-CPU Large (2 vCPUs, 4.0 GiB)
              const: c7i.large
            - title: C7i High-CPU XL (4 vCPUs, 8.0 GiB)
              const: c7i.xlarge
            - title: C7i High-CPU 2XL (8 vCPUs, 16.0 GiB)
              const: c7i.2xlarge
            - title: C7i High-CPU 4XL (16 vCPUs, 32.0 GiB)
              const: c7i.4xlarge
            - title: C7i High-CPU 8XL (32 vCPUs, 64.0 GiB)
              const: c7i.8xlarge
            - title: C6i High-CPU Large (2 vCPUs, 4.0 GiB)
              const: c6i.large
            - title: C6i High-CPU XL (4 vCPUs, 8.0 GiB)
              const: c6i.xlarge
            - title: C6i High-CPU 2XL (8 vCPUs, 16.0 GiB)
              const: c6i.2xlarge
            - title: C6i High-CPU 4XL (16 vCPUs, 32.0 GiB)
              const: c6i.4xlarge
            - title: C6i High-CPU 8XL (32 vCPUs, 64.0 GiB)
              const: c6i.8xlarge
            - title: C5 High-CPU Large (2 vCPUs, 4.0 GiB)
              const: c5.large
            - title: C5 High-CPU XL (4 vCPUs, 8.0 GiB)
              const: c5.xlarge
            - title: C5 High-CPU 2XL (8 vCPUs, 16.0 GiB)
              const: c5.2xlarge
            - title: C5 High-CPU 4XL (16 vCPUs, 32.0 GiB)
              const: c5.4xlarge
            - title: C5 High-CPU 9XL (36 vCPUs, 72.0 GiB)
              const: c5.9xlarge
            - title: C5 High-CPU 12XL (48 vCPUs, 96.0 GiB)
              const: c5.12xlarge
            - title: C5 High-CPU 18XL (72 vCPUs, 144.0 GiB)
              const: c5.18xlarge
            - title: C5 High-CPU 24XL (96 vCPUs, 192.0 GiB)
              const: c5.24xlarge
            - title: M7i General Purpose Large (2 vCPUs, 8.0 GiB)
              const: m7i.large
            - title: M7i General Purpose XL (4 vCPUs, 16.0 GiB)
              const: m7i.xlarge
            - title: M7i General Purpose 2XL (8 vCPUs, 32.0 GiB)
              const: m7i.2xlarge
            - title: M7i General Purpose 4XL (16 vCPUs, 64.0 GiB)
              const: m7i.4xlarge
            - title: M7i General Purpose 8XL (32 vCPUs, 128.0 GiB)
              const: m7i.8xlarge
            - title: M6i General Purpose Large (2 vCPUs, 8.0 GiB)
              const: m6i.large
            - title: M6i General Purpose XL (4 vCPUs, 16.0 GiB)
              const: m6i.xlarge
            - title: M6i General Purpose 2XL (8 vCPUs, 32.0 GiB)
              const: m6i.2xlarge
            - title: M6i General Purpose 4XL (16 vCPUs, 64.0 GiB)
              const: m6i.4xlarge
            - title: M6i General Purpose 8XL (32 vCPUs, 128.0 GiB)
              const: m6i.8xlarge
            - title: M5 General Purpose Large (2 vCPUs, 8.0 GiB)
              const: m5.large
            - title: M5 General Purpose XL (4 vCPUs, 16.0 GiB)
              const: m5.xlarge
            - title: M5 General Purpose 2XL (8 vCPUs, 32.0 GiB)
              const: m5.2xlarge
            - title: M5 General Purpose 4XL (16 vCPUs, 64.0 GiB)
              const: m5.4xlarge
            - title: M5 General Purpose 8XL (32 vCPUs, 128.0 GiB)
              const: m5.8xlarge
            - title: M5 General Purpose 12XL (48 vCPUs, 192.0 GiB)
              const: m5.12xlarge
            - title: M5 General Purpose 16XL (64 vCPUs, 256.0 GiB)
              const: m5.16xlarge
            - title: M5 General Purpose 24XL (96 vCPUs, 384.0 GiB)
              const: m5.24xlarge
            - title: R7i Memory Optimized Large (2 vCPUs, 16.0 GiB)
              const: r7i.large
            - title: R7i Memory Optimized XL (4 vCPUs, 32.0 GiB)
              const: r7i.xlarge
            - title: R7i Memory Optimized 2XL (8 vCPUs, 64.0 GiB)
              const: r7i.2xlarge
            - title: R7i Memory Optimized 4XL (16 vCPUs, 128.0 GiB)
              const: r7i.4xlarge
            - title: R6i Memory Optimized Large (2 vCPUs, 16.0 GiB)
              const: r6i.large
            - title: R6i Memory Optimized XL (4 vCPUs, 32.0 GiB)
              const: r6i.xlarge
            - title: R6i Memory Optimized 2XL (8 vCPUs, 64.0 GiB)
              const: r6i.2xlarge
            - title: R6i Memory Optimized 4XL (16 vCPUs, 128.0 GiB)
              const: r6i.4xlarge
            - title: T3 Small (2 vCPUs for a 4h 48m burst, 2.0 GiB)
              const: t3.small
            - title: T3 Medium (2 vCPUs for a 4h 48m burst, 4.0 GiB)
              const: t3.medium
            - title: T3 Large (2 vCPUs for a 7h 12m burst, 8.0 GiB)
              const: t3.large
            - title: T3 XL (4 vCPUs for a 9h 36m burst, 16.0 GiB)
              const: t3.xlarge
            - title: T3 2XL (8 vCPUs for a 9h 36m burst, 32.0 GiB)
              const: t3.2xlarge
          advanced_configuration_enabled:
            type: boolean
            title: Advanced Configuration Enabled
            default: false
        dependencies:
          advanced_configuration_enabled:
            oneOf:
            - properties:
                advanced_configuration_enabled:
                  const: false
            - properties:
                advanced_configuration_enabled:
                  const: true
                advanced_configuration:
                  type: object
                  title: Advanced Configuration
                  properties:
                    taint:
                      "$ref": https://raw.githubusercontent.com/massdriver-cloud/artifact-definitions/main/definitions/types/k8s-node-taint.json
                      description: "**Warning**: if you only have one node pool, and it has a taint, other core workloads may not be able to be scheduled and provisioning will fail. If you want to taint a node group, it's recommended that you have another, non-tainted pool for these workloads."
                      "$md.immutable": true
    monitoring:
      type: object
      title: Monitoring
      required:
      - control_plane_log_retention
      properties:
        control_plane_log_retention:
          type: integer
          title: Control Plane Log Retention
          description: 'Duration to retain control plane logs in AWS Cloudwatch (Note: control plane logs do not contain application or container logs)'
          default: 7
          oneOf:
          - title: 7 days
            const: 7
          - title: 30 days
            const: 30
          - title: 90 days
            const: 60
          - title: 180 days
            const: 180
          - title: 1 year
            const: 365
          - title: Never expire
            const: 0

connections:
  required:
  - aws_authentication
  - vpc
  properties:
    aws_authentication:
      "$ref": massdriver/aws-iam-role
    vpc:
      "$ref": massdriver/aws-vpc

artifacts:
  required:
  - kubernetes_cluster
  properties:
    kubernetes_cluster:
      "$ref": massdriver/kubernetes-cluster

ui:
  ui:order:
  - k8s_version
  - fargate
  - node_groups
  - monitoring
  - "*"
  k8s_version:
    ui:field: versioningDropdown
  node_groups:
    items:
      ui:order:
      - name
      - instance_type
      - min_size
      - max_size
      - "*"
  monitoring:
    ui:order:
    - control_plane_log_retention
    - "*"
